---
description: 
globs: 
alwaysApply: true
---
---
title: zodã«ã‚ˆã‚‹å‹•çš„å‹ä»˜ã‘ã®å°å…¥
description: æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯zodã«ã‚ˆã‚‹å‹•çš„å‹ä»˜ã‘ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ã¾ã™
---
### é–‹ç™ºã«ãŠã‘ã‚‹ãƒ«ãƒ¼ãƒ«ãƒ»åˆ¶ç´„
- Firestoreã¯å¿…ãš `Zod with TypeConverter` å°å…¥ã¨ã‚»ãƒƒãƒˆã§ä½¿ç”¨ã™ã‚‹ã“ã¨
- Convererã‚’å¼•ãå›ã—ã¤ã¤ã€Firestoreã¸ã®æ›¸ãè¾¼ã¿(èª­ã¿è¾¼ã¿)ãŒç™ºç”Ÿã™ã‚‹Objectã«ã¤ã„ã¦ã¯ã€å¿…ãšModelã‚’ç”¨æ„ã™ã‚‹é‹ç”¨ã¨ã™ã‚‹

### æœŸå¾…ã™ã‚‹åŠ¹æœ
- ãƒã‚¯ã®æ¸›å°‘
    - èª°ã§ã‚‚å¥½ããªã ã‘DBã«å€¤ã‚’ç™»éŒ²ã§ãã‚‹çŠ¶æ…‹ ã‚’é˜²æ­¢ ã‹ã¤ å‹å®šç¾©ã«æ²¿ã£ãŸã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¯èƒ½ã«ã™ã‚‹ã“ã¨ã§ãƒã‚°ç™ºç”Ÿé »åº¦ã‚’æ¸›ã‚‰ã™
- é–‹ç™ºé€Ÿåº¦ã®å‘ä¸Š
    - `ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«é›†ä¸­ã™ã‚‹ã“ã¨ã§è‡ªå‹•çš„ã«Firestoreã‚‚æœ€é©åŒ–ã•ã‚Œã‚‹` ä½“é¨“ã®æä¾›ã«ã‚ˆã‚‹é–‹ç™ºé€Ÿåº¦UP
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®å …ç‰¢æ€§å‘ä¸Š
    - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ¡ä»¶ãŒãã®ã¾ã¾ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«é©ç”¨ã•ã‚Œã‚‹ã®ã§å®‰å®šæ€§ãŒUPã™ã‚‹

### å—ã‘å…¥ã‚Œã‚‹ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
- ä»–Firestoreãƒ©ãƒƒãƒ‘ãƒ¼ã®æƒ…å ±ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—
- Firestoreä»¥å¤–ã®NoSQLã‚‚ã—ãã¯ã€é€šå¸¸ã®RDBãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç”¨ã„ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«ãŠã‘ã‚‹ãƒã‚¦ãƒã‚¦ã®è“„ç©

### å‚è€ƒURL / æ›¸ç±
[Zod + Firestore ã§æ¥½ã«ä½¿ãˆã‚‹æ±ç”¨Converter : å‹ä»˜ã‘ã¨ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã®é­”æ³• #GameWith #TechWith #Zod #Firestore - GameWith Developer Blog](https://tech.gamewith.co.jp/entry/2023/12/05/115148)

[0-1. ã¯ã˜ã‚ã«ï½œé€†å¼•ã å‹ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ Zod](https://zenn.dev/terrierscript/books/2023-01-typed-zod/viewer/0-1-introduction)

[FirestoreDataConverter | JavaScript SDK Â |Â  Firebase JavaScript API reference](https://firebase.google.com/docs/reference/js/v8/firebase.firestore.FirestoreDataConverter)

### è©³è§£ / ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹å®Ÿè£… (Vue SFC)
- **æ±ç”¨TypeConverterã®ã‚³ãƒ¼ãƒ‰**
    - å‹ã‚’1ã¤ã—ã‹æ¸¡ã›ãªã„ã®ã§ã€`from`ã«ãƒ•ãƒ«å®šç¾©ã‚’ç½®ã„ã¦ã€`to` ã¯ Partial<T>ã§è¡¨ç¾
    - `to` ã§ã¯ã€id/createdAt/updatedAtã¯ å—ã‘æ¸¡ã—æ™‚ã®Coverterã§ã¯ä¸è¦ã¨ã™ã‚‹
        - `createdAt` ã¨ `upatedAt` â†’ to ã§æ›¸ãè¾¼ã¿æ™‚ã«è‡ªå‹•ã§ä»˜ä¸ã™ã‚‹
        - `id` â†’ `from` ã§èª­ã¿è¾¼ã‚€æ™‚ã«Docã«ä»˜ä¸ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹

```tsx
import log from "@utils/logger";
import {
  Timestamp,
  type FirestoreDataConverter,
  type QueryDocumentSnapshot,
} from "firebase/firestore";

import type { z } from "zod";

export const firestoreTypeConverter = <T extends z.AnyZodObject>(
  schema: T
): FirestoreDataConverter<z.infer<T>> => ({
  toFirestore: (data: Partial<z.infer<T>>): z.infer<T> => {
    log("INFO", "conveter toFirestoreğŸ¤–", "parsedDocData is....", data);
    let additionalData = {};

    if (!data.createdAt) {
      // æ–°è¦ä½œæˆæ™‚ã¯createdAtã¨updatedAtã«ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¨­å®š
      additionalData = {
        createdAt: Timestamp.fromDate(new Date()),
        updatedAt: Timestamp.fromDate(new Date()),
      };
    } else {
      // æ›´æ–°æ™‚ã¯updatedAtã®ã¿ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¨­å®š
      additionalData = {
        updatedAt: Timestamp.fromDate(new Date()),
      };
    }
    const mergedDoc = { ...data, ...additionalData };
    // æ›¸ãè¾¼ã¿æ™‚ã¯idã‚’æŒãŸãªã„ã®ã§ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰é™¤å¤–
    const withoutIdSchema = schema.omit({
      id: true,
    });
    const parsedDocData = withoutIdSchema.strict().parse(mergedDoc);
    return parsedDocData;
  },
  fromFirestore: (snapshot: QueryDocumentSnapshot<z.infer<T>>): z.infer<T> => {
    const parsedDocData = snapshot.data();
    log(
      "INFO",
      "conveter fromFirestoreğŸ¤–",
      "parsedDocData is....",
      parsedDocData
    );
    const dataWithId = { ...parsedDocData, id: snapshot.id };
    const validatedDocData = schema.strict().parse(dataWithId);
    return validatedDocData;
  },
});
```
- **ãƒ¢ãƒ‡ãƒ«æ¯ã®Typeã‚³ãƒ¼ãƒ‰**
    - Convererã‚’å¼•ãå›ã—ã¤ã¤ã€Firestoreã¸ã®æ›¸ãè¾¼ã¿(èª­ã¿è¾¼ã¿)ãŒç™ºç”Ÿã™ã‚‹Objectã«ã¤ã„ã¦ã¯ã€å¿…ãšModelã‚’ç”¨æ„ã™ã‚‹é‹ç”¨ã¨ã™ã‚‹
        - modelãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹3ã¤ã‚’è¿”å´ã™ã‚‹
            1. id/createdAt/updatedAtã‚’ä»˜ä¸ã—ãŸã€fromã‹ã‚‰å—ã‘å–ã‚‹ã¨ãã®zod.object
            2. 1ã‚’å‹åŒ–ã—ãŸType
            3. 1ã‚’å¼•ãæ¸¡ã—ã¦ç”Ÿæˆã—ãŸå¯¾è±¡Modelå°‚ç”¨ã®TypeConverter

```tsx
import { z } from "zod";
import { firestoreTypeConverter } from "./firestoreTypeConverter";
import { Timestamp } from "firebase/firestore";

// ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©
export const organizationSchema = z.object({
  name: z.string(),
  code: z.string(),
});

// id, createdAt, updatedAtã®3ã¤ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ãŸæ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©
export const decodedOrganizationSchema = organizationSchema.extend({
  id: z.string(),
  createdAt: z.instanceof(Timestamp),
  updatedAt: z.instanceof(Timestamp),
});

// ã‚¹ã‚­ãƒ¼ãƒã‚’ã‚‚ã¨ã«å‹ã‚’ä½œæˆ
export type decodedOrganizationSchema = z.infer<
  typeof decodedOrganizationSchema
>;

// Firestoreã®TypeConverterã‚’ä½œæˆ
export const organizationConverter = firestoreTypeConverter(
  decodedOrganizationSchema
);
```